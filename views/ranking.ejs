<%
<!-- possible args -->
var isAdmin;
var targetPage;
var productDataList;
var lastUpdateMoment;
var productTypeBundleId;
var targetProductTypeId;
var isDateSpecified;
var originalURL;
var productIdToIsNewProductHash;
var productIdIntoTwitterAltSearchWordModelsHash;

const Ctype = Const.PRODUCT_TYPE_NAME_TO_ID_HASH;
const Cbundle = Const.PRODUCT_TYPE_BUNDLE_NAME_TO_ID;

const DEFAULT_TEXT = {
    title: 'タイトルが指定されていません',
    desc: 'descriptionが指定されていません',
};

// slice for pagination
var start = (targetPage - 1) * Const.PRODUCT_NUM_PER_PAGE;
var end = start + Const.PRODUCT_NUM_PER_PAGE;
var productDataListForThisPage = productDataList.slice(start, end);
var rank1Buzz = productDataList[0] && productDataList[0].statDataModel ? productDataList[0].statDataModel.buzz : 0;
var texts = Const.RANKING_PAGE_META[productTypeBundleId] || DEFAULT_TEXT;
var productTypeBundleName = Const.PRODUCT_TYPE_BUNDLE_ID_TO_NAME_HASH[productTypeBundleId];
var productTypeIds = Const.PRODUCT_TYPE_BUNDLE_ID_TO_PRODUCT_TYPE_IDS[productTypeBundleId];
var isNoBuzzThresholdProductType = !__.isEmpty(__.intersection(productTypeIds, Const.EXCEPTION_NO_BUZZ_NUM_THRESHOLD_PRODUCT_TYPE_IDS));
var isAllCategory = productTypeBundleId == 999;
%>

<!DOCTYPE html>
<link href="/css/luminous-basic.min.css" rel="stylesheet">
<link href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" rel="stylesheet"
      integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
<link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.8.1/css/all.css"
      integrity="sha384-50oBUHEmvpQ+1lW4y57PTFmhCaXp0ML5d60M1M7uH2+nqUivzIebhndOJK28anvf" crossorigin="anonymous">
<link href="/css/accordion.css" rel="stylesheet">
<link href="/css/common.css" rel="stylesheet">
<link href="/css/ranking.css" rel="stylesheet">

<html>
<head>
    <title><%- texts.title %></title>

    <meta name="viewport"
          content="width=device-width,initial-scale=1.0,minimum-scale=1.0,maximum-scale=1.0,user-scalable=no">

    <meta name="description" content=<%= texts.desc %>>

    <% if (1 < targetPage) { %>
        <link rel=”prev”
              href=”https://www.buzzranking.net/ranking/<%= productTypeBundleName %>?page=<%= targetPage - 1 %>”>
    <% } %>

    <% if (targetPage < pageMax) { %>
        <link rel=”next”
              href=”https://www.buzzranking.net/ranking/<%= productTypeBundleName %>?page=<%= targetPage + 1 %>”>
    <% } %>

</head>
<body>

<%- include(appRoot + '/views/header.ejs') %>

<div id="content" class="container-fluid">

    <% if (lastUpdateMoment) { %>
        <div class="row">
            <div class="col-12">
                <div class="text-align-left">
                    <span class="last-updated-at"><%= lastUpdateMoment.locale('ja').format("YYYY年MMMDo") %></span>
                    最終更新
                </div>
            </div>
        </div>
    <% } %>

    <% if (productTypeBundleId && productTypeBundleId != Cbundle.all && 2 <= productTypeIds.length) { %>
        <ul class="nav nav-tabs">
            <li class="nav-item tab-item"><a href="/ranking/<%= productTypeBundleName %>"
                                             class="nav-link <%= targetProductTypeId ? '' : 'active' %>">総合</a></li>
            <%
            __.each(Const.PRODUCT_TYPE_BUNDLE_ID_TO_PRODUCT_TYPE_IDS[productTypeBundleId], productTypeId => {
                var productTypeName = Const.PRODUCT_TYPE_ID_TO_NAME_HASH[productTypeId];
                var productTypeJapaneseName = Const.PRODUCT_TYPE_ID_TO_JA_NAME_HASH[productTypeId];
                var isTargetType = productTypeId == targetProductTypeId;
            %>
            <li class="nav-item tab-item"><a href="/ranking/<%= productTypeBundleName %>?type=<%= productTypeName %>"
                                             class="nav-link <%= isTargetType ? 'active' : '' %>"><%= productTypeJapaneseName %></a>
            </li>
            <% }); %>
        </ul>
    <% } %>

    <%
    __.times(productDataListForThisPage.length, function(n) {
        var productData = productDataListForThisPage[n];
        var productModel = productData.productModel;
        var statDataModel = productData.statDataModel;
        var productId = productModel.productId;
        var productModelName = productData.productClassName;
        var productInfoTemplatePath = 'product_info/' + productModelName + '.ejs';
        var buzz = productData.statDataModel ? productData.statDataModel.buzz : 0;
        var progressBarPercentage = ((buzz / rank1Buzz) * 100) || 0;
        var belongeProductBundleId = Const.PRODUCT_TYPE_ID_TO_BELONGED_PRODUCT_TYPE_BUNDLE_ID[productModel.productTypeId];
        var bundleName = Const.PRODUCT_TYPE_BUNDLE_ID_TO_NAME_HASH[belongeProductBundleId];
        var bundleNameJA = Const.PRODUCT_TYPE_BUNDLE_ID_TO_JA_NAME_HASH[belongeProductBundleId];

        var rank = statDataModel.rank;
        var categoryRank = statDataModel.categoryRank;
    %>

    <div class="row product-row-block">
        <!--<div class="col-md-12 col-lg-6">-->
        <div class="col-md-12">
            <!--<div class="product-block shadow bg-white rounded"-->
            <div class="product-block product-block-border"
                 data-product-id="<%= productId %>">

                <span class="product-block-border-title relative">
                    <% if (buzz) { %>
                        <span class="d-flex align-items-end no-wrap">
                            <% if (isAllCategory) { %>
                                <% if (0 <= rank && rank <= 3) { %>
                                    <img src="/img/ranking/rank_<%= rank %>_crown.png" class="rank-crown-img">
                                <% } %>

                                <%= rank %>位&nbsp;
                                <span class="category-rank-text">
                                    (<a href="/ranking/<%= bundleName %>"><%= bundleNameJA %>カテゴリ</a> <%= statDataModel.categoryRank %>位)
                                </span>
                            <% } else { %>
                                <% if (0 <= categoryRank && categoryRank <= 3) { %>
                                    <img src="/img/ranking/rank_<%= categoryRank %>_crown.png" class="rank-crown-img">
                                <% } %>
                                <%= categoryRank %>位
                            <% } %>
                        </span>
                    <% } %>
                </span>

                <div class="product-detail-icon">
                    <a href="/product/detail/<%= productId %>">
                        <i class="fas fa-file-contract"></i>
                    </a>
                </div>

                <div class="row d-flex align-items-center product-block-header">
                    <div class="col-12 d-flex align-items-center justify-content-center">
                        <h2 class="product-title">
                            <a href="/product/detail/<%= productId %>">
                                <%= productData.productModel.title %>
                            </a>

                            <% if (isAdmin && productIdToIsNewProductHash && productIdToIsNewProductHash[productId]) { %>
                                （！新商品！)
                            <% } %>

                        </h2>
                    </div>
                </div>

                <!--<i class="fas fa-fire progress-bar-buzz-icon"></i>-->
                <div class="row">
                    <div class="col-12">
                        <a href="/product/detail/<%= productId %>">
                            <div class="progress-bar-area">
                                <div class="progress">
                                <span class="progress-bar progress-bar-striped bg-danger" aria-valuenow="75"
                                      aria-valuemin="0"
                                      aria-valuemax="100" style="width: <%= progressBarPercentage %>%">
                                    <%= buzz %> Buzz
                                </span>
                                </div>
                            </div>
                        </a>
                    </div>
                </div>

                <%- include(productInfoTemplatePath, { productData: productData, }) %>

                <%
                if (isAdmin) {
                    var altSearchModels = productIdIntoTwitterAltSearchWordModelsHash ? productIdIntoTwitterAltSearchWordModelsHash[productId] : [];
                %>
                <br>
                <p class="text-align-center">Admin用</p>
                <p>validityStatus: <%= productData.productModel.validityStatus %></p>

                <% __.each(altSearchModels, altSearchModel => { %>
                    <div class="row">
                        <div class="col-6">
                            <%= altSearchModel.searchWord %>
                        </div>
                        <div class="col-6">
                            <button type="button" class="btn btn-danger update-alt-search-word-validity-status"
                                    data-search-word="<%= altSearchModel.searchWord %>"
                                    value="<%= Const.VALIDITY_STATUS_NAME_TO_ID.invalid %>">
                                <i class="fas fa-trash-alt"></i>
                            </button>
                        </div>
                    </div>
                <% }); %>

                <div class="row">
                    <div class="col-4">
                        <button type="button" class="btn btn-danger update-product-validity-status"
                                value="<%= Const.VALIDITY_STATUS_NAME_TO_ID.invalid %>">
                            ブロック<i class="fas fa-trash-alt"></i>
                        </button>
                    </div>
                    <div class="col-4">
                        <button type="button" class="btn btn-warning delete-tweet-and-tweet-count-log"
                                value="<%= Const.VALIDITY_STATUS_NAME_TO_ID.invalid %>">
                            この商品に関連する全てのツイートとTweetCountLogを削除
                        </button>
                    </div>
                    <div class="col-4">
                        <button type="button" class="btn btn-success update-product-validity-status"
                                value="<%= Const.VALIDITY_STATUS_NAME_TO_ID.protected %>">
                            保護ステータスに更新
                        </button>
                    </div>
                </div>
                <% } %>
            </div>

        </div>
    </div>

    <% if ((n + 1) % 4 == 0) { %>
        <%- include(appRoot + '/public/ad/adsense/in_feed.html') %>
    <% } %>

    <% }); %>

    <% if (productDataListForThisPage.length % 4 != 0 && productDataListForThisPage.length < Const.PRODUCT_NUM_PER_PAGE) { %>
        <%- include(appRoot + '/public/ad/adsense/in_feed.html') %>
    <% } %>

    <% if (!productDataListForThisPage.length) { %>
        <div class="row">
            <div class="col-12 text-align-center p-5">
                該当カテゴリでランキング内の商品はありません
            </div>
        </div>
    <% } %>

    <% if (!isNoBuzzThresholdProductType && targetPage == pageMax) { %>
        <div class="threshold-buzz-count-description">
            ※ Buzzが<%= Const.THRESHOLD_COUNT_OF_OUT_OF_RANGE_USER_COUNT %>未満の商品・サービスはランキングには表示されません
        </div>
    <% } %>

    <%- include('ranking_pagination.ejs', { pageMax: pageMax, }) %>
</div>

<%- include(appRoot + '/views/footer.ejs') %>

<% if (isAdmin) { %>
    <div id="is-admin-dummy-div" style="display: none;"></div>
<% } %>

<script src="/js/compressed/ranking.min.js" type="text/javascript"></script>
</body>
</html>
